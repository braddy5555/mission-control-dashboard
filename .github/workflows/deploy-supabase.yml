name: Deploy Supabase Schema

on:
  push:
    branches:
      - master
    paths:
      - 'supabase/migrations/**'
  workflow_dispatch:
    inputs:
      project:
        description: 'Project to deploy'
        required: true
        default: 'both'
        type: choice
        options:
          - cosmic-puppies
          - tribes-community
          - both

jobs:
  deploy-cosmic:
    runs-on: ubuntu-latest
    if: github.event.inputs.project == 'cosmic-puppies' || github.event.inputs.project == 'both' || github.event.inputs.project == ''
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Supabase CLI
        run: |
          curl -fsSL https://github.com/supabase/cli/releases/download/v1.142.0/supabase_1.142.0_linux_amd64.deb -o supabase.deb
          sudo dpkg -i supabase.deb
          rm supabase.deb
      
      - name: Deploy Cosmic Puppies Schema
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase link --project-ref mocalplhdzvuiobltcqu --password ${{ secrets.COSMIC_DB_PASSWORD }}
          supabase db push

  deploy-tribes:
    runs-on: ubuntu-latest
    if: github.event.inputs.project == 'tribes-community' || github.event.inputs.project == 'both' || github.event.inputs.project == ''
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Supabase CLI
        run: |
          curl -fsSL https://github.com/supabase/cli/releases/download/v1.142.0/supabase_1.142.0_linux_amd64.deb -o supabase.deb
          sudo dpkg -i supabase.deb
          rm supabase.deb
      
      - name: Deploy Tribes Community Schema
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase link --project-ref shriiexysllxlvjncwol --password ${{ secrets.TRIBES_DB_PASSWORD }}
          supabase db push
